<?xml version='1.0' encoding='UTF-8'?>
<workflow>
  <meta name="jira.description">This JIRA Service Desk Support Workflow was generated for Project AAS-CDR (This copy was automatically generated from a draft, when workflow 'AAS: Support Workflow Ver. 2.0' was made inactive.)</meta>
  <meta name="jira.i18n.description" />
  <meta name="jira.update.author.key">atlassian</meta>
  <meta name="jira.updated.date">1495193174986</meta>
  <meta name="sd.workflow.key">sdItSupport</meta>
  <meta name="jira.update.author.name">admin</meta>
  <initial-actions>
    <action id="1" name="Create Issue">
      <meta name="opsbar-sequence">0</meta>
      <meta name="jira.description" />
      <meta name="jira.i18n.description" />
      <meta name="jira.i18n.title">common.forms.create</meta>
      <validators>
        <validator name="" type="class">
          <arg name="permission">Create Issue</arg>
          <arg name="class.name">com.atlassian.jira.workflow.validator.PermissionValidator</arg>
        </validator>
      </validators>
      <results>
        <unconditional-result old-status=")‚Äö‚â§√π" status=":‚Äî¬ß" step="11">
          <post-functions>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueCreateFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
              <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">–Ø–Æ—üo–å—ú–Ø–åi¬∑—ç–ø–ã–±—á—ã–µ–≠[–≠¬ßy–£G&lt;k–Æ</arg>
              <arg name="FIELD_NOTES">Set custom field "Customer request description" with the description of the selected request type</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">√£√ç:√Ø√év√ï√æ¬ù√≠√Æ|kM[√´m√∫u√Ωyu√è;√≥¬ü9{G√¥</arg>
              <arg name="FIELD_NOTES">Select assignee based on a balanced search of the user with the lower number of assigned issues</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.bc.issue.search.SearchService
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.issue.Issue
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.user.util.UserUtil
import com.atlassian.jira.web.bean.PagerFilter
import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.fields.OrderableField
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.event.type.EventDispatchOption

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

String PrjKey = issue.getProjectObject().key
SearchService 		searchService 		= ComponentAccessor.getComponent(SearchService.class)
UserUtil 			userUtil 			= ComponentAccessor.getUserUtil()
IssueManager 		issueManager 		= ComponentAccessor.getIssueManager()
ComponentManager 	componentManager 	= ComponentManager.getInstance()
CustomFieldManager 	customFieldManager 	= componentManager.getCustomFieldManager()
IssueChangeHolder 	changeHolder 		= new DefaultIssueChangeHolder()
def 				indexManager 		= componentManager.getIndexManager()
def 				groupManager 		= ComponentAccessor.getGroupManager()

User oldUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()	
ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(ComponentAccessor.getUserUtil().getUserObject("atlassian"))

int min_assigned_issues = 0
String assignee
String jqlSearch
List issues
SearchService.ParseResult parseResult
int j = 0

User currentUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()	

if (PrjKey == 'CDR' &amp;&amp; (issue.issueTypeObject.name == 'Technical Support Issue' || issue.issueTypeObject.name == 'Technical Docs' || issue.issueTypeObject.name == 'Task')){
    assignee = "martina.bergamini"
}else{
    if (PrjKey == 'AAS' &amp;&amp; issue.issueTypeObject.name == 'Spare Parts'){
        assignee = "simone.fini"
    }else{
        if (PrjKey == 'AAS' &amp;&amp; issue.issueTypeObject.name == 'Technical Docs'){
            assignee = "roberta.dolcini"
        }else{
            groupManager.getUsersInGroup("FAACWorldSupportTeam").each{ user -&gt;
                jqlSearch = "(project = 'AAS' OR project='CDR') AND issuetype != Sub-task AND assignee = '" + user.getName() + "' AND status NOT IN ('Closed','Expired Request')"
                log.debug "AAS -------&gt; Check user: " + user.getName()
                log.debug "AAS -------&gt; Query: " + jqlSearch
                //requestParticipantsList.add(userUtil.getUserByName(user.getName()));
                
                parseResult = searchService.parseQuery(currentUser, jqlSearch)
                if (parseResult.isValid()) {
                    def searchResult = searchService.search(currentUser, parseResult.getQuery(), PagerFilter.getUnlimitedFilter())
                    // Transform issues from DocumentIssueImpl to the "pure" form IssueImpl (some methods don't work with DocumentIssueImps)
                    issues = searchResult.issues.collect {issueManager.getIssueObject(it.id)}
                    log.debug "AAS -------&gt; Utente: " + user.getName()
                    log.debug "AAS -------&gt; Num. issue assegnate: " + issues.size()
                    if((j == 0 || issues.size() &lt; min_assigned_issues) &amp;&amp; !user.getName().toString().equals("roberta.dolcini")) {
                        min_assigned_issues = issues.size()
                        assignee = user.getName()
                        log.debug "AAS -------&gt; Update min_assigned_issue: " + min_assigned_issues
                        log.debug "AAS -------&gt; Update assignee: " + assignee
                    }
                    j++
                }
            }
        }
    }
}

log.debug "AAS -------&gt; Selected assignee: " + assignee
issue.setAssignee(ComponentManager.instance.userUtil.getUserObject(assignee))
issue.store()
indexManager.reIndex(issue)

//log.debug "Assignee: " + assignee

ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(oldUser)
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">√ë√ç¬µ√ó¬ç8√ë¬Ω√π√õF¬∑m√é√ª√∑¬ñ√Ωu√≠√ùy¬Æ√õw¬û4√Ø¬∑¬∂</arg>
              <arg name="FIELD_NOTES">Update "Request Participants"</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">//Aggiornamento "Request Participants"
import com.atlassian.jira.util.ImportUtils
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.Issue
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.index.IssueIndexManager
import com.atlassian.jira.index.Index.Manager
import com.atlassian.jira.event.type.EventDispatchOption
import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.user.ApplicationUser
import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.user.util.UserManager
import com.atlassian.crowd.embedded.api.Group

def groupManager = ComponentAccessor.getGroupManager()

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
def indexManager = ComponentAccessor.getIssueIndexManager()
IssueChangeHolder changeHolder = new DefaultIssueChangeHolder()
CustomField requestParticipants = customFieldManager.getCustomFieldObject("17100".toLong())
CustomField ccAddresses = customFieldManager.getCustomFieldObject("14404".toLong())

//In produzione aggiungere il cambio utente in modo che la modifica la faccia 'atlassian'
User oldUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()
ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(ComponentAccessor.getUserUtil().getUserObject("atlassian"))

def userUtil = ComponentAccessor.getUserUtil()
List&lt;ApplicationUser&gt; requestParticipantsList = []
List&lt;ApplicationUser&gt; ccAddressesList = []
String v_jiraGroup = null
com.atlassian.crowd.embedded.api.Group not_jiraGroup = null

def retValue
String n_jiraGroup

userUtil.getGroupNamesForUser(issue.reporter.name).each { group -&gt;
    // Ricerco il gruppo di appartenenza dell'utente - non HS-customers a cui appartengono tutti gli utenti ma quello specifico del team di visibilit√†
	if(group != "AAS-customers" &amp;&amp; group.contains("AAS-Visibility-")){
        v_jiraGroup = group
        retValue = groupManager.getUsersInGroup(group).each{ user -&gt;
            if(user.getName() != issue.reporter.name){
            	requestParticipantsList.add(userUtil.getUserByName(user.getName()));
            }
        }
    }
}

if (v_jiraGroup != null){
	n_jiraGroup = "AAS-Notifications-" + v_jiraGroup.substring(0+v_jiraGroup.indexOf("Visibility-")+11,v_jiraGroup.size())
	not_jiraGroup = ComponentAccessor.getUserManager().getGroup(n_jiraGroup);
}    

if (not_jiraGroup != null){
    retValue = groupManager.getUsersInGroup(not_jiraGroup).each{ user -&gt;
           	ccAddressesList.add(userUtil.getUserByName(user.getName()));
    }
}

if(requestParticipantsList.size() &gt; 0){
	requestParticipants.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(requestParticipants),requestParticipantsList),changeHolder)
    indexManager.reIndex(issue);
}

if(ccAddressesList.size() &gt; 0){
	ccAddresses.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(ccAddresses),ccAddressesList),changeHolder)
    indexManager.reIndex(issue);
}

ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(oldUser)</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowreindexissue-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
            </function>
            <function type="class">
              <arg name="eventTypeId">1</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">AAS Support - Send email notification for Issue Create</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS" />
              <arg name="FIELD_TO_ADDRESSES" />
              <arg name="FIELD_CC_ADDRESSES" />
              <arg name="FIELD_CC_USER_FIELDS">customfield_14100</arg>
              <arg name="FIELD_FUNCTION_ID">√ó√é√ü√≥Oxo¬æ:√ß}√∫√©¬Æ¬üq√ç√ü√≠¬∑tkg{u√é¬û}t</arg>
              <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Verdana"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
										
										&lt;!-- Custom field: Product Category --&gt;
										&lt;!-- ID Svil: 15500 --&gt;
										&lt;!-- ID Prod: 15802 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name != "Suggestions"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15802")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
														  &lt;b&gt;Product Category &lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15802"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Model --&gt;
										&lt;!-- ID Svil: 15502 --&gt;
										&lt;!-- ID Prod: 15803 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name != "Suggestions" &amp;&amp; issue.issueTypeObject.name != "Technical Docs"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15803")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Model &lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
													  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15803"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Product Code --&gt;
										&lt;!-- ID Svil: 15501 --&gt;
										&lt;!-- ID Prod: 15804 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name != "Suggestions" &amp;&amp; issue.issueTypeObject.name != "Spare Parts"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15804")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Product Code &lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15804"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Serial Number --&gt;
										&lt;!-- ID Svil: 15503 --&gt;
										&lt;!-- ID Prod: 15703 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name != "Suggestions" &amp;&amp; issue.issueTypeObject.name != "Technical Support Issue" &amp;&amp; issue.issueTypeObject.name != "Info"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15703")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Serial Number &lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15703"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Date --&gt;
										&lt;!-- ID Svil: 15504 --&gt;
										&lt;!-- ID Prod: 15805 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name == "Fault"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15805")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Installation Date &lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15805")).toString().substring(0,10)%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Site Description --&gt;
										&lt;!-- ID Svil: 15505 --&gt;
										&lt;!-- ID Prod: 15807 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name == "Fault"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15807")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Site Description &lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15807"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Problem Type --&gt;
										&lt;!-- ID Svil: 15507 --&gt;
										&lt;!-- ID Prod: 15808 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name == "Fault"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15808")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Problem Type&lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15808"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Request description --&gt;
                                        &lt;tr&gt;
                                        	&lt;td width="30%" class="details-field-name"&gt;
                                        		&lt;b&gt;Request description&lt;/b&gt;
                                        	&lt;/td&gt;
                                        	&lt;td class="details-field-value"&gt;
                                        		&lt;% if (issue.description.contains("{html}")) { %&gt;
                                        			&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
                                        		&lt;% }else{ %&gt;
                                        			&lt;% out &lt;&lt; issue.description %&gt;
                                        		&lt;% } %&gt;
                                        	&lt;/td&gt;
                                        &lt;/tr&gt;
										
										&lt;!-- Custom field: Revision --&gt;
										&lt;!-- ID Svil: 15508 --&gt;
										&lt;!-- ID Prod: 15809 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name == "Fault"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15809")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Revision&lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15809"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Occurs --&gt;
										&lt;!-- ID Svil: 15508 --&gt;
										&lt;!-- ID Prod: 15810 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name == "Fault"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15810")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Occurs&lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15810"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: N¬∞ of cases --&gt;
										&lt;!-- ID Svil: 15510 --&gt;
										&lt;!-- ID Prod: 15811 --&gt;
										&lt;% if(issue.getProjectObject().key == "AAS" &amp;&amp; issue.issueTypeObject.name == "Fault"){ %&gt;
											&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15811")) != null) { %&gt;
												&lt;tr&gt;
													&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;N¬∞ of cases&lt;/b&gt;
													&lt;/td&gt;
													&lt;td class="details-field-value"&gt;
														&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15811"))%&gt;
													&lt;/td&gt;
												&lt;/tr&gt;
											&lt;% } %&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">AAS-8</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
          </post-functions>
        </unconditional-result>
      </results>
    </action>
  </initial-actions>
  <common-actions>
    <action id="761" name="Close this issue" view="fieldscreen">
      <meta name="jira.field.resolution.include">1,10301</meta>
      <meta name="opsbar-sequence">30</meta>
      <meta name="jira.i18n.submit">sd.workflow.itsupport.v2.transition.resolve.this.issue.submit</meta>
      <meta name="jira.description" />
      <meta name="jira.i18n.description">sd.workflow.itsupport.v2.transition.resolve.this.issue.description</meta>
      <meta name="jira.i18n.title">sd.workflow.itsupport.v2.transition.resolve.this.issue.title</meta>
      <meta name="jira.fieldscreen.id">15301</meta>
      <meta name="sd.tour.resolve.step">¬∂¬ª≈æ</meta>
      <results>
        <unconditional-result old-status="Not Done" status="‚Ä∞√û" step="13">
          <post-functions>
            <function type="class">
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdateissuestatus-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
            </function>
            <function type="class">
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowcreatecomment-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
            </function>
            <function type="class">
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowgeneratechangehistory-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
              <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">—Ö¬Æv¬ß7{¬Æ9–øO=—á–≠;–ønk–ã—úsn—ç–Ø¬Æ—äq–æ—Ñ</arg>
              <arg name="FIELD_NOTES">Update "Customer request description" custom field</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowreindexissue-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
            </function>
            <function type="class">
              <arg name="eventTypeId">13</arg>
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">AAS Support - Send email notification for "Close issue"</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
              <arg name="FIELD_TO_ADDRESSES" />
              <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">–≥}‚Ä∫–π–û&lt;–Ω—á¬∂{n—ôo][–©¬Æ–¨–≥¬≠5–ø–ßz–±¬∑7q¬∂—ô</arg>
              <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE" />
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
          </post-functions>
        </unconditional-result>
      </results>
    </action>
    <action id="911" name="Reopen issue" view="fieldscreen">
      <meta name="sd.resolution.clear" />
      <meta name="jira.description" />
      <meta name="jira.fieldscreen.id">14302</meta>
      <results>
        <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="11">
          <post-functions>
            <function type="class">
              <arg name="field.name">resolution</arg>
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdate-issue-field-function</arg>
              <arg name="field.value" />
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueFieldFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
              <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">—Ç¬ªu{–•–è‚ñà–Ñ–á—Ö—Ç–∏5‚îò—è4—å‚ï¨–π‚ñÄ–î{–Æ‚ñÄ—çM–™</arg>
              <arg name="FIELD_NOTES">Update "Customer request description" custom field</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
            </function>
            <function type="class">
              <arg name="eventTypeId">7</arg>
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">AAS Support - Send email notification for "Reopen issue"</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS" />
              <arg name="FIELD_TO_ADDRESSES" />
              <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">—É–ã–©¬ß—Ü—É–≠z{–å–±–∑]y¬≠—äs–Ö–Æk‚Ä†¬µ—á¬Æu–µ¬Æ‚Ä∫</arg>
              <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE" />
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
          </post-functions>
        </unconditional-result>
      </results>
    </action>
  </common-actions>
  <steps>
    <step id="10" name="Waiting for customer">
      <meta name="jira.status.id">10024</meta>
      <meta name="sd.step.key">¬±√ï‚Ä¶
√´-¬¢g¬´</meta>
      <actions>
        <action id="781" name="Customer back to support">
          <meta name="jira.i18n.submit">sd.workflow.itsupport.v2.transition.respond.to.support.submit</meta>
          <meta name="opsbar-sequence">10</meta>
          <meta name="jira.description" />
          <meta name="jira.i18n.description">sd.workflow.itsupport.v2.transition.respond.to.support.description</meta>
          <meta name="jira.i18n.title">sd.workflow.itsupport.v2.transition.respond.to.support.title</meta>
          <meta name="jira.fieldscreen.id" />
          <results>
            <unconditional-result old-status="Not Done" status="‚Ä∞√û" step="11">
              <post-functions>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdateissuestatus-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowcreatecomment-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step
 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

//log.debug "reporter: " + issue.reporter.name
/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

//log.debug "Stato corrente: " + issue.getStatusObject().id
def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

//log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	//log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

//log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">—Ç¬ªu{–•–è‚ñà–Ñ–á—Ö—Ç–∏5‚îò—è4—å‚ï¨–π‚ñÄ–î{–Æ‚ñÄ—çM–™</arg>
                  <arg name="FIELD_NOTES">Set custom field "Customer request description" with the description of the selected request type</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level
import com.atlassian.jira.event.type.EventDispatchOption

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()
//issueManager.updateIssue(ComponentAccessor.getJiraAuthenticationContext().getLoggedInUser(), issue, EventDispatchOption.ISSUE_UPDATED, false)</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowgeneratechangehistory-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowreindexissue-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Customer Back to Support"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS" />
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">–π–∑—Å—ç—ôw—ô—à–µ—ï_–≥—ôu–Ω–ætk¬´—åk~–à{_o–à—è</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="871" name="Expired">
          <meta name="opsbar-sequence">20</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id" />
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="12">
              <post-functions>
                <function type="class">
                  <arg name="field.name">resolution</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdate-issue-field-function</arg>
                  <arg name="field.value">10301</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueFieldFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√óg[{¬ó|√ó}¬π√ì¬ó√ª√£g}y¬∂¬ü¬é√∂√ó¬∑√õw√á√Ω{o</arg>
                  <arg name="FIELD_NOTES">Set custom field "Customer request description" with the description of the selected request type</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Expired"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS" />
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">√õ√Ü¬ús¬≠¬ªy√û]√ï√è:√•√æ¬õw]¬∏√≠√ø{√ï¬ß√ù√ì¬Ωw√ù¬∑√ö</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="881" name="Send comment to customer" view="fieldscreen">
          <meta name="opsbar-sequence">30</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15300</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="10">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">o¬≠¬õ√©√Øx√ó¬¶¬∏s¬á¬ù√Øf√ºk¬∂√∏√ß¬é]√Ø]√ü¬ß6y¬æv</arg>
                  <arg name="FIELD_NOTES">Set custom field "Customer request description" with the description of the selected request type</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Send comment to customer"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">w¬ó¬ö√ó¬¶¬∫s}m|u¬Ω¬ºwOwf√ö√õm¬∫√±√ç5√ì√é</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">AAS-9</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="11" name="In Progress">
      <meta name="jira.status.id">3</meta>
      <actions>
<common-action id="761" />
        <action id="851" name="Respond to customer" view="fieldscreen">
          <meta name="opsbar-sequence">10</meta>
          <meta name="jira.i18n.submit">sd.workflow.itsupport.v2.transition.respond.to.customer.submit</meta>
          <meta name="jira.description" />
          <meta name="jira.i18n.description" />
          <meta name="jira.i18n.title">sd.workflow.itsupport.v2.transition.respond.to.customer.title</meta>
          <meta name="jira.fieldscreen.id">15300</meta>
          <results>
            <unconditional-result old-status="Not Done" status="‚Ä∞√û" step="10">
              <post-functions>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdateissuestatus-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowcreatecomment-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowgeneratechangehistory-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

//log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        //log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

//log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

//log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        //log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	//log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            //log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

//log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√©√ß√∏√£¬ó:ooZ√©√ñ√µ√µ√çu¬ù¬∑√´¬á¬µq√ç¬∑u√õ¬≠√∫</arg>
                  <arg name="FIELD_NOTES">Update "Customer request description" custom field</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowreindexissue-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Respond to customer"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">s=√ü¬∑√∑√ßW√πw√ñ√ù√Øwy√ß¬ûo¬ß^q√é6√´G\kGw</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="891" name="Hold for investigation" view="fieldscreen">
          <meta name="opsbar-sequence">20</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">11201</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="14">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

//log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        //log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

//log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

//log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        //log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	//log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            //log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

//log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√≥√é√Ωk√ü:{¬∂√∑√ô√á7√´¬ù√õ√ô¬æ√úw¬∂√∂¬Æ¬ª√ë¬∑√∏√•√év</arg>
                  <arg name="FIELD_NOTES">Update "Customer request description" custom field</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Hold for investigation"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS" />
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">}¬Æ¬∂}√Æ6√ó~√ó¬ù¬õ√±√Æ√ª√≥¬ó√∫w¬ß5u¬Æ:√ô√çv√´¬∑¬∑</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15813")) != null){ %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√õ¬Ωv√ô¬Æ√º√•√üz√ô√ñ√¥√≠¬∑7sGw√õ√á√ù¬ß8q√é\i√Æ¬ú</arg>
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

if (issue.getCustomFieldValue(ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15813".toLong())) != null){

    List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
    Comment comment = (Comment)transientVars.get("commentValue");

    changeItems.each {item -&gt;
        if (item.getField().toString().equals("Attachment")){

            if (comment != null){
                sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
            }else{
                sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
            }

            conn = ConnectionFactory.getConnection(helperName);
            sql = new Sql(conn)

            try {
                StringBuffer sb = new StringBuffer()
                sql.execute(sqlStmt)
            }
            finally {
                sql.close()
            }
        }
    }


    if (comment != null){

        MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
        comment_to_be_updated.setRoleLevelId("10300".toLong())
        ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

        sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"

        conn = ConnectionFactory.getConnection(helperName);
        sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
        }    
    }
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="field.name">customfield_15813</arg>
                  <arg name="full.module.key">com.googlecode.jira-suite-utilitiesupdateIssueCustomField-function</arg>
                  <arg name="field.value">≈æ√©e</arg>
                  <arg name="class.name">com.googlecode.jsu.workflow.function.UpdateIssueCustomFieldPostFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="901" name="Send comment to customer" view="fieldscreen">
          <meta name="opsbar-sequence">60</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15300</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="11">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√´¬ç¬ösWo¬Ø:k¬ñ¬ú√ìw√∑√∑¬Ω√Ω√õ¬üum¬Ω&lt;s√ñ√õy√û</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Set custom field "Customer request description" with the description of the selected request type</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Send comment to customer"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">√ó¬Æ√µ√∑]¬ºi√æ¬û√£¬û¬õ¬Ø:√Øn{√ï√á√≥f√ùs¬∑zsF√¥</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="12" name="Expired Request">
      <meta name="jira.status.id">11927</meta>
      <actions>
<common-action id="761" />
<common-action id="911" />
        <action id="921" name="Send comment to customer" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15300</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="12">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">}√ótw√é√∑{¬Æ¬µy√Æ√õ√∑¬ç¬µoNq√≠v{¬ó√ú√´√ù\√±√∑¬õ</arg>
                  <arg name="FIELD_NOTES">Set custom field "Customer request description" with the description of the selected request type</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Send comment to customer"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">w¬ó¬ö√ó¬¶¬∫s}m|u¬Ω¬ºwOwf√ö√õm¬∫√±√ç5√ì√é</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="13" name="Closed">
      <meta name="jira.status.id">6</meta>
      <actions>
<common-action id="911" />
      </actions>
    </step>
    <step id="14" name="Hold for investigation">
      <meta name="jira.status.id">11928</meta>
      <actions>
        <action id="931" name="Restart progress" view="fieldscreen">
          <meta name="opsbar-sequence">10</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">11201</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="11">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√ó√ü√∑√ûz√ó√ó√µV¬∂√°√ù5√ó¬ût√•¬∑¬∫w√ù¬π√Øn¬ù√ï√Æ√ö</arg>
                  <arg name="FIELD_NOTES">Update "Customer request description" custom field</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Restart progress"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS" />
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">‚ïô–Æ5‚ñÄV‚ï¢—É‚ïü‚ñê‚ï§‚ñåu‚ïê6m‚ï¢‚ï£‚îò‚ïõ‚ñàV‚ï°—á–Ω]{–ø7</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15813")) != null){ %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

if (issue.getCustomFieldValue(ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15813".toLong())) != null){

    List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
    Comment comment = (Comment)transientVars.get("commentValue");

    changeItems.each {item -&gt;
        if (item.getField().toString().equals("Attachment")){

            if (comment != null){
                sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
            }else{
                sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
            }

            conn = ConnectionFactory.getConnection(helperName);
            sql = new Sql(conn)

            try {
                StringBuffer sb = new StringBuffer()
                sql.execute(sqlStmt)
            }
            finally {
                sql.close()
            }
        }
    }


    if (comment != null){

        MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
        comment_to_be_updated.setRoleLevelId("10300".toLong())
        ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

        sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"

        conn = ConnectionFactory.getConnection(helperName);
        sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
        }    
    }
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="field.name">customfield_15813</arg>
                  <arg name="full.module.key">com.googlecode.jira-suite-utilitiesupdateIssueCustomField-function</arg>
                  <arg name="field.value">≈æ√©e</arg>
                  <arg name="class.name">com.googlecode.jsu.workflow.function.UpdateIssueCustomFieldPostFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="941" name="Send comment to customer" view="fieldscreen">
          <meta name="opsbar-sequence">20</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15300</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="14">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">Œ≥‚ÄîŒÆwŒû9œÉMŒ´uŒΩw¬Ω:œÖŒÆŒåŒ∑ŒÆŒâŒ£MœÑŒøŒßŒ¨{‚Äî}</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
        log.debug(it.LANGUAGE_ID)
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "Stato corrente: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "Query per label in lingua" + query
conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "Query per label in inglese" + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "next status desc: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√µ√ó¬üm¬≠√´^}m√æ√∑√´√ñ¬π√ì¬ß5√ï√æum√ç√£¬∂¬û√°√ó¬¥</arg>
                  <arg name="FIELD_NOTES">Set custom field "Customer request description" with the description of the selected request type</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Level

import groovy.sql.Sql
import java.sql.Driver
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")
log.setLevel(org.apache.log4j.Level.DEBUG)

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager()
IssueManager issueManager = ComponentAccessor.getIssueManager()

CustomField request_description = customFieldManager.getCustomFieldObject(Long.parseLong("15800"))
CustomField status_description = customFieldManager.getCustomFieldObject(Long.parseLong("15801"))
CustomField requestTypeId = customFieldManager.getCustomFieldObject(Long.parseLong("17110"))
Object companyValue = issue.getCustomFieldValue(request_description)

def indexManager = ComponentAccessor.getIssueIndexManager()

def requestLabel
def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT u.LABEL " + 
    				"FROM TRANSLATEDLABEL AS u " + 
    				"JOIN VIEWPORTREQUESTTYPE ON u.TRANSLATION_ID = VIEWPORTREQUESTTYPE.REQUEST_TYPE_NAME_ID " + 
    				"WHERE u.LANGUAGE_ID = 'en' AND VIEWPORTREQUESTTYPE.ID = " + issue.getCustomFieldValue(requestTypeId)

log.debug "query per request name: " + queryLanguage

try {
    sql.eachRow(queryLanguage) {
        requestLabel = it.LABEL
        log.debug(it.LABEL)
    }
} finally {
    sql.close()
    conn.close()
}

def changeHolder = new DefaultIssueChangeHolder();
request_description.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(request_description), requestLabel), changeHolder);
issue.setCustomFieldValue(request_description,requestLabel)

issue.store()</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">AAS Support - Send email notification for "Send comment to customer"</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">aa-support@faacgroup.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES">techsupport@faacgroup.com</arg>
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">w¬ó¬ö√ó¬¶¬∫s}m|u¬Ω¬ºwOwf√ö√õm¬∫√±√ç5√ì√é</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"Verdana";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.aa-summary{
        	color:#000000;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Verdana";
            font-size:14pt;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"Verdana";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Verdana";
            font-size:10pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Verdana";
            font-size:9pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#FFFFFF;
			padding:10px 10px 10px 10px;
			font-family:"Verdana";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Verdana";
			font-size:11pt;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:11pt;
			font-family:"Verdana";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		a.title-mail-reference{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		a.title-mail-portal{
			font-family:"Verdana";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#CF6400;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"Verdana";
			font-size:11pt;
			display: inline-block;
			color:#000000;
		}
		p.type-above{
			font-family:"Verdana";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-aa{
			border-radius: 3px; 
			font-size: 8pt; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #FFFFFF; 
			border: 1px solid #CF6400; 
			color: #000000; 
			margin-left: 5px; 
			font-weight: bold; 
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td colspan="2"&gt;
													&lt;img src="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/images/loghi/logo_Access_Automation.png"/&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td colspan="2" width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-portal" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25"&gt;
                                                              &lt;b&gt;Access Automation Support Portal&lt;/b&gt;
															&lt;/a&gt; - &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15800"))%&gt;
															
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
											&lt;tr&gt;
												&lt;td&gt;&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold;font-size:11pt;color:#CF6400;"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="aa-summary" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: ????? --&gt;
										&lt;span class="status-name-aa"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://aa-support.faacgroup.com/servicedesk-ui/customer/portal/25/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
							&lt;/table&gt;
                            &lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
                                &lt;tr&gt;
                                    &lt;td class="comment-box"&gt;									
                                        &lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
                                            &lt;p class="title-comment"&gt;
                                                &lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p class="author-comment"&gt;
                                                &lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
                                                &lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
                                            &lt;/p&gt;
                                            &lt;p style='margin-top:6.0pt'&gt;
                                                &lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
                                                    &lt;% out &lt;&lt; lastComment %&gt;
                                                &lt;/span&gt;
                                            &lt;/p&gt;
                                        &lt;% } %&gt;
                                    &lt;/td&gt;
                                &lt;/tr&gt;
                           	&lt;/table&gt;
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Verdana";color:#000000'&gt;This message is automatically generated by FAAC Access Automation Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[$issue.project.name Portal][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("aa-support@faacgroup.com")
return true</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
  </steps>
</workflow>