<?xml version='1.0' encoding='UTF-8'?>
<workflow>
  <meta name="jira.description">Workflow to be used in HUB Service flow with JIRA Service Desk</meta>
  <meta name="jira.update.author.key">arianna.fabbri</meta>
  <meta name="jira.updated.date">1488381591242</meta>
  <initial-actions>
    <action id="1" name="Create">
      <validators>
        <validator name="" type="class">
          <arg name="permission">Create Issue</arg>
          <arg name="class.name">com.atlassian.jira.workflow.validator.PermissionValidator</arg>
        </validator>
      </validators>
      <results>
        <unconditional-result old-status="≈æ√©e" status="¬¢‚Äî¬ß" step="1">
          <post-functions>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueCreateFunction</arg>
            </function>
            <function type="class">
              <arg name="field.name">resolution</arg>
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdate-issue-field-function</arg>
              <arg name="field.value" />
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueFieldFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">√õ~√ô√∂¬ö√°√Ω√≥¬ßw^√Ø¬é9sn¬∑√±√û¬¥√Ø√é¬ù√µ√é√π</arg>
              <arg name="FIELD_NOTES">Add new request to PORTALREQUESTS table on JIRA_ServiceDesk DB</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def requestTypeID = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17401".toLong())
def requestTypeIDValue = issue.getCustomFieldValue(requestTypeID)

def groupManager = ComponentAccessor.getGroupManager()
if(groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers') &amp;&amp; requestTypeIDValue != null){
    def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 
    def props = new Properties()
    props.setProperty("user", "JIRA_ServiceDesk") 
    props.setProperty("password", "S3rvice2305!FaAc#")
    def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    def sql = new Sql(conn)

    log.debug "reporter: " + issue.reporter.name
    log.debug "Request type selected: " + requestTypeIDValue
    
    def sqlStmt = "INSERT INTO PORTALREQUESTS (VIEWPORT_ID, JIRA_ISSUE_KEY, VIEWPORTREQUESTTYPE_ID) VALUES (24" + ", '" + issue.key + "', " + requestTypeIDValue + ")"

    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }
    
}else{
    return false
}</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">k¬≠¬û√ô¬Æxk¬ø^o^√¥√≥√ó\{√áZ√ô¬∑|√ü_√´o]√ü√ü]</arg>
              <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def newStatusDesc = ""
def userLanguage = ""

def portalRequestField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17110".toLong())
def portalRequestFieldValue = issue.getCustomFieldValue(portalRequestField)

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

log.debug "## HUB Support Portal - Create new request ## Reporter: " + issue.reporter.name

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

log.debug "## HUB Support Portal - Create new request ## Current Status: " + issue.getStatusObject().id

def query = "SELECT tl.LABEL " +
           	"FROM TRANSLATEDLABEL as tl " + 
           	"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
           	"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
           	"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
           	"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"

log.debug "## HUB Support Portal - Create new request ## Query per label in lingua: " + query


conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.VIEWPORTREQUESTTYPE_ID = '" + portalRequestFieldValue + "' AND sm.JIRA_STATUS_ID = " + issue.getStatusObject().id + " LIMIT 1"
    
	log.debug "## HUB Support Portal - Create new request ## Query per label in inglese: " + query
    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
            log.debug(it.LABEL)
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

log.debug "## HUB Support Portal - Create new request ## Next status description: " + newStatusDesc
def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">√ì√ü5√≥M¬ûq√¶√ösw:√ù¬∂¬∂wOZ√≥O5√©¬Ω√ûm¬¶¬ù√•¬∂√¥</arg>
              <arg name="FIELD_NOTES">Label issue as HSPortal or HSInternal issue</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.ComponentManager
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.issue.label.LabelManager

def userUtil = ComponentAccessor.getUserUtil()
def	indexManager = ComponentAccessor.getIssueIndexManager()

def com.atlassian.crowd.embedded.api.User currentUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()

if (userUtil.getGroupNamesForUser(currentUser.name).contains("HS-customers") &amp;&amp; !userUtil.getGroupNamesForUser(currentUser.name).contains("HS-internal-reporters")){
	LabelManager labelManager = ComponentAccessor.getComponent(LabelManager)
	def labels = labelManager.getLabels(issue.id).collect{it.getLabel()}
	labels += 'HSPortal'
	labelManager.setLabels(currentUser,issue.id,labels.toSet(),false,false)

	indexManager.reIndex(issue);
}

if (userUtil.getGroupNamesForUser(currentUser.name).contains("HS-internal-reporters")){
	LabelManager labelManager = ComponentAccessor.getComponent(LabelManager)
	def labels = labelManager.getLabels(issue.id).collect{it.getLabel()}
	labels += 'InternalHS'
	labelManager.setLabels(currentUser,issue.id,labels.toSet(),false,false)

	indexManager.reIndex(issue);
}</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">i–î}q–ö:‚ñà_—Å–∏xm¬ßy–ü–æ‚ïù—Ç–∫—ài—èwq—ç–•–∂–æ¬ß</arg>
              <arg name="FIELD_NOTES">Set Alessandro Guidetti assignee of InternalHS and issue of type Access</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.ComponentManager
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.issue.label.LabelManager

def userUtil = ComponentAccessor.getUserUtil()
def	indexManager = ComponentAccessor.getIssueIndexManager()

def com.atlassian.crowd.embedded.api.User oldUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()
ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(ComponentAccessor.getUserUtil().getUserObject("atlassian"))
def com.atlassian.crowd.embedded.api.User currentUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()

if (userUtil.getGroupNamesForUser(oldUser.name).contains("HS-internal-reporters") || issue.issueTypeObject.name == "Access"){
    issue.setAssignee(ComponentManager.instance.userUtil.getUserObject("alessandro.guidetti"))
	indexManager.reIndex(issue);
    ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(oldUser)
}</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">–±–¶–æ—è–≠v—É–æ:—Å—ü—ç—çwG9—èG–ò{f–ño–ù–æ–π—ó—ó</arg>
              <arg name="FIELD_NOTES">Define Request Participants &amp; CC Addresses</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">//Aggiornamento "Request Participants"
import com.atlassian.jira.util.ImportUtils
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.Issue
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.index.IssueIndexManager
import com.atlassian.jira.index.Index.Manager
import com.atlassian.jira.event.type.EventDispatchOption
import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.user.ApplicationUser
import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.user.util.UserManager
import com.atlassian.crowd.embedded.api.Group

import org.apache.log4j.Category
Category log = Category.getInstance("com.onresolve.jira.groovy.PostFunction")

log.setLevel(org.apache.log4j.Level.DEBUG)

def groupManager = ComponentAccessor.getGroupManager()

def customFieldManager = ComponentAccessor.getCustomFieldManager()
def indexManager = ComponentAccessor.getIssueIndexManager()
IssueChangeHolder changeHolder = new DefaultIssueChangeHolder()

//27.12.2016: sostituito campo Request participants - 14100 - del plugin Service Desk con il nuovo campo custom 17100
CustomField requestParticipants = customFieldManager.getCustomFieldObject("17100".toLong())
CustomField ccAddresses = customFieldManager.getCustomFieldObject("14404".toLong())

//In produzione aggiungere il cambio utente in modo che la modifica la faccia 'atlassian'
User oldUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()
ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(ComponentAccessor.getUserUtil().getUserObject("atlassian"))

def userUtil = ComponentAccessor.getUserUtil()
List&lt;ApplicationUser&gt; requestParticipantsList = []
List&lt;ApplicationUser&gt; ccAddressesList = []
def v_jiraGroup = ""
def n_jiraGroup = null
com.atlassian.crowd.embedded.api.Group not_jiraGroup = null
def retValue

userUtil.getGroupNamesForUser(issue.reporter.name).each { group -&gt;
    // Ricerco il gruppo di appartenenza dell'utente - non HS-customers a cui appartengono tutti gli utenti ma quello specifico del team di visibilit√†
	if(group != "HS-customers" &amp;&amp; group.contains("HS-Visibility-")){
        v_jiraGroup = group
        retValue = groupManager.getUsersInGroup(group).each{ user -&gt;
            if(user.getName() != issue.reporter.name){
            	requestParticipantsList.add(userUtil.getUserByName(user.getName()));
            }
        }
    }
}

if (v_jiraGroup != null &amp;&amp; v_jiraGroup.contains("Visibility-")){
	n_jiraGroup = "HS-Notifications-" + v_jiraGroup.substring(0+v_jiraGroup.indexOf("Visibility-")+11,v_jiraGroup.size())
	not_jiraGroup = ComponentAccessor.getUserManager().getGroup(n_jiraGroup);
}    

if (not_jiraGroup != null){
    retValue = groupManager.getUsersInGroup(not_jiraGroup).each{ user -&gt;
           	ccAddressesList.add(userUtil.getUserByName(user.getName()));
    }
}

if(requestParticipantsList.size() &gt; 0){
	requestParticipants.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(requestParticipants),requestParticipantsList),changeHolder)
    indexManager.reIndex(issue);
}

if(ccAddressesList.size() &gt; 0){
	ccAddresses.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(ccAddresses),ccAddressesList),changeHolder)
    indexManager.reIndex(issue);
}

ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(oldUser)</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">√ï¬Æ√û√∑√ù√õ{√Ü¬¥√ù√Ø|√üN¬¥s¬Ø√ô√óxkg_√´^;√≠√û&lt;</arg>
              <arg name="FIELD_NOTES">[false] Update issue summary for issues created from Support Portal</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">/* Update issue summary for issues created from Support Portal */
false
/*
import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.user.util.UserUtil
import com.atlassian.jira.issue.IssueManager
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.event.type.EventDispatchOption

ComponentManager componentManager = ComponentManager.getInstance()
CustomFieldManager customFieldManager =	componentManager.getCustomFieldManager()
IssueManager issueManager = componentManager.getIssueManager()
def indexManager = componentManager.getIndexManager()
IssueChangeHolder changeHolder = new DefaultIssueChangeHolder()
userUtil = componentManager.getUserUtil()
def com.atlassian.crowd.embedded.api.User currentUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()

//Request Installation Number
CustomField requestInstNumb = customFieldManager.getCustomFieldObject(14124)
Object requestInstNumbValue = issue.getCustomFieldValue(requestInstNumb).toString()

if (userUtil.getGroupNamesForUser(currentUser.name).contains("HS-customers") &amp;&amp; !userUtil.getGroupNamesForUser(currentUser.name).contains("HS-internal-reporters")){
    issue.summary = "[" + issue.key + "] [" + requestInstNumbValue.substring(0,requestInstNumbValue.indexOf("-")-1) + "] " + issue.summary  
    issueManager.updateIssue(currentUser, issue, EventDispatchOption.DO_NOT_DISPATCH, false)
	indexManager.reIndex(issue);  
}
*/

</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">m¬¶¬π{G√∂s¬≠√ö√´w4√£N4√ì√û]√ü¬éw√≠√û9wg√ï¬Ω^</arg>
              <arg name="FIELD_NOTES">[false] Aggiornamento campi interni Brand, Environment, ecc..</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">false
/*import com.atlassian.jira.ComponentManager
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.CustomFieldManager
import com.atlassian.jira.user.util.UserUtil
import com.atlassian.jira.issue.IssueManager
import org.apache.log4j.Level
import com.atlassian.jira.issue.customfields.view.CustomFieldParams
import com.atlassian.jira.issue.customfields.option.Option
import com.atlassian.jira.issue.fields.CustomField
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.issue.customfields.view.CustomFieldParams
import com.atlassian.jira.issue.customfields.option.LazyLoadedOption
import com.atlassian.jira.issue.customfields.impl.CascadingSelectCFType
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.user.util.UserManager
 
ComponentManager componentManager = ComponentManager.getInstance()
CustomFieldManager customFieldManager =	componentManager.getCustomFieldManager()
IssueManager issueManager = componentManager.getIssueManager()
def indexManager = componentManager.getIndexManager()
IssueChangeHolder changeHolder = new DefaultIssueChangeHolder()

User oldUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()
ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(ComponentAccessor.getUserUtil().getUserObject("atlassian"))

//Request Brand
CustomField requestBrand = customFieldManager.getCustomFieldObject(14122)
Object requestBrandValue = issue.getCustomFieldValue(requestBrand).toString()

//Request Environment
CustomField requestEnv = customFieldManager.getCustomFieldObject(14123)
Object requestEnvValue = issue.getCustomFieldValue(requestEnv).toString()

//Request Installation Number
CustomField requestInstNumb = customFieldManager.getCustomFieldObject(14124)
Object requestInstNumbValue = issue.getCustomFieldValue(requestInstNumb).toString()


def customFieldID

switch(requestBrandValue){
	case "Datapark":
    	switch(requestEnvValue){
            case "Hardware":
            	customFieldID = 14102
            break
            case "Software":
                customFieldID = 14103			
            break
            case "Manuals":
                customFieldID = 14116			
            break
         }
    break
        
    case "Orion":
    	switch(requestEnvValue){
            case "Hardware":
            	customFieldID = 14104
            break
            case "Software":
                customFieldID = 14106			
            break
            case "Manuals":
                customFieldID = 14105			
            break
         }
    break
        
    case "Orion XR":
    	switch(requestEnvValue){
            case "Hardware":
            	customFieldID = 14107
            break
            case "Software":
                customFieldID = 14109			
            break
            case "Manuals":
                customFieldID = 14108			
            break
         }
   	break
        
    case "Zeag":
    	switch(requestEnvValue){
            case "Hardware":
            	customFieldID = 14119
            break
            case "Software":
                customFieldID = 14121			
            break
            case "Manuals":
                customFieldID = 14120			
            break
         }
    break
        
    case "Parqube":
    	switch(requestEnvValue){
            case "Hardware":
            	customFieldID = 14116
            break
            case "Software":
                customFieldID = 14118			
            break
            case "Manuals":
                customFieldID = 14117			
            break
         }
    break
        
    case "Paragon":
    	switch(requestEnvValue){
            case "Hardware":
            	customFieldID = 14110
            break
            case "Software":
                customFieldID = 14112			
            break
            case "Manuals":
                customFieldID = 14111			
            break
         }
    break
        
    case "Parkplus":
    	switch(requestEnvValue){
            case "Hardware":
            	customFieldID = 14113
            break
            case "Software":
                customFieldID = 14115			
            break
            case "Manuals":
                customFieldID = 14114			
            break
         }
    break

}



CustomField prod = customFieldManager.getCustomFieldObject(customFieldID)
Object prodValue = issue.getCustomFieldValue(prod)

Option parent
Option child

HashMap&lt;String, Option&gt; hashMapEntries = (HashMap&lt;String, Option&gt;) prodValue
if (hashMapEntries != null) {
parent = hashMapEntries.get(CascadingSelectCFType.PARENT_KEY)
child = hashMapEntries.get(CascadingSelectCFType.CHILD_KEY)
}

CustomField brand = customFieldManager.getCustomFieldObject(12900)
Object brandValue = issue.getCustomFieldValue(brand)
brand.updateValue(null, issue, new ModifiedValue(brandValue,requestBrandValue),changeHolder)

CustomField envirnoment = customFieldManager.getCustomFieldObject(12901)
Object envirnomentValue = issue.getCustomFieldValue(envirnoment)
envirnoment.updateValue(null, issue, new ModifiedValue(envirnomentValue,requestEnvValue),changeHolder)

CustomField family = customFieldManager.getCustomFieldObject(12902)
Object familyValue = issue.getCustomFieldValue(family)
family.updateValue(null, issue, new ModifiedValue(familyValue,parent.toString()),changeHolder)

CustomField product = customFieldManager.getCustomFieldObject(12903)
Object productValue = issue.getCustomFieldValue(product)
product.updateValue(null, issue, new ModifiedValue(productValue,child.toString()),changeHolder)


CustomField instNumber = customFieldManager.getCustomFieldObject(11002)
Object instNumberValue = issue.getCustomFieldValue(instNumber)
instNumber.updateValue(null, issue, new ModifiedValue(instNumberValue,requestInstNumbValue),changeHolder)

indexManager.reIndex(issue);

ComponentManager.instance.jiraAuthenticationContext.setLoggedInUser(oldUser)*/</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_ACTION">11 AssignToTechnician</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.FasttrackTransition</arg>
              <arg name="FIELD_CONDITION">import com.atlassian.crowd.embedded.api.User
import com.atlassian.jira.user.util.UserManager
import com.atlassian.jira.util.ImportUtils
import com.atlassian.jira.ComponentManager
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.issue.label.LabelManager

ComponentManager 	componentManager = 	ComponentManager.getInstance()
com.atlassian.crowd.embedded.api.User currentUser = ComponentManager.instance.jiraAuthenticationContext.getLoggedInUser()
def userUtil = componentManager.getUserUtil()
LabelManager labelManager = ComponentAccessor.getComponent(LabelManager)

(!userUtil.getGroupNamesForUser(issue.reporter.name).contains("HS-customers") &amp;&amp; issue.getProjectObject().key == 'HS') || (labelManager.getLabels(issue.id).collect{it.getLabel()}.contains('InternalHS') &amp;&amp; issue.getProjectObject().key == 'HS')</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_ADDITIONAL_SCRIPT" />
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Send mail to agents for ORION/ORION XR</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">support@hubparking.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
              <arg name="FIELD_TO_ADDRESSES">Marcel.Feusi@hubparking.com, Erich.Muehlebach@hubparking.com, Erik.Steiert@hubparking.com, Peter.Keller@hubparking.com</arg>
              <arg name="FIELD_CC_ADDRESSES">alessandro.guidetti@hubparking.com</arg>
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">√µ√Ø√ï¬∂¬¥√ï¬ß\√ë√á¬πw}6√°¬∑¬¥{¬ù¬ª√±√ßy√õ¬ç√±√ß√∂</arg>
              <arg name="FIELD_TO_USER_FIELDS" />
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="hub-summary" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: 17111 --&gt;
										&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
										&lt;% if (issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
                                        &lt;% if (!issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													$issue.description
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Request Created][&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObjectByName("HUB Brand")) %&gt;][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

//ORION/ORION XR Agents notification
issue.projectObject.name == 'HUB Support' &amp;&amp; (cfValues['HUB Brand'] == 'Orion' || cfValues['HUB Brand'] == 'Orion XR')</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">HS-665</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Send mail to agents for FAAC</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">support@hubparking.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
              <arg name="FIELD_TO_ADDRESSES">alessandro.guidetti@hubparking.com</arg>
              <arg name="FIELD_CC_ADDRESSES" />
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">√©√û√∏√µ√æ5{¬è√ó¬∑√ª√£G¬∂√µ√é9√ó¬é¬∂√´¬Æ√ü√ßW|s¬ø</arg>
              <arg name="FIELD_TO_USER_FIELDS" />
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="hub-summary" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: 17111 --&gt;
										&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
										&lt;% if (issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
                                        &lt;% if (!issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													$issue.description
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
                                        
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Request Created][&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObjectByName("HUB Brand")) %&gt;][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

//FAAC Agents notification
issue.projectObject.name == 'HUB Support' &amp;&amp; (cfValues['HUB Brand'] == 'Paragon' || cfValues['HUB Brand'] == 'Parkplus' || cfValues['HUB Brand'] == 'Parqube' || cfValues['HUB Brand'] == 'Zeag')
</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">HS-4009</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Send mail to agents for Datapark</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">support@hubparking.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
              <arg name="FIELD_TO_ADDRESSES">lilia.slavova@hubparking.com, teodora.ivanova@hubparking.com</arg>
              <arg name="FIELD_CC_ADDRESSES">alessandro.guidetti@hubparking.com</arg>
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">Œ≥Œó¬∂œÖŒ≠‚Ä∫y¬∂œäŒµŒΩœåŒø^\Œ±¬¶¬∂Œ±ŒéŒª}5qœé¬∂Œ£¬ÆœÖ</arg>
              <arg name="FIELD_TO_USER_FIELDS" />
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="hub-summary" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: 17111 --&gt;
										&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
										&lt;% if (issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
                                        &lt;% if (!issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													$issue.description
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Request Created][&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObjectByName("HUB Brand")) %&gt;][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

//DATAPARK Agent notification
issue.projectObject.name == 'HUB Support' &amp;&amp; cfValues['HUB Brand'] == 'Datapark'</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">HS-665</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Send mail to Reporter (customer portal issue)</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">support@hubparking.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
              <arg name="FIELD_TO_ADDRESSES" />
              <arg name="FIELD_CC_ADDRESSES" />
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">√õ¬ñ¬ûi√øv√é√µ√©√ù6√±√Ø√õ√û}√´√é√º√•√ç¬∂√©√û√õ√•√Æ¬µ</arg>
              <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: 17111 --&gt;
										&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
										&lt;% if (issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
                                        &lt;% if (!issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													$issue.description
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Request Created][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')
</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">HS-665</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Send mail to Internal Reporter</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">support@hubparking.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
              <arg name="FIELD_TO_ADDRESSES" />
              <arg name="FIELD_CC_ADDRESSES" />
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">–±¬≠–Ö–≥—ú–û=–π–ÖZ–∑—ï[–∑‚Ä†—ö–≥}ZwW=–øn—ä}–ó</arg>
              <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
										&lt;br/&gt;
										&lt;a class="hub-summary" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
											$issue.summary
										&lt;/a&gt;
										&lt;!-- Custom field: Next Status Description --&gt;
										&lt;!-- ID Svil: 15602 --&gt;
										&lt;!-- ID Prod: 15801 --&gt;
										&lt;!-- Custom field: Next Status Color --&gt;
										&lt;!-- ID Svil: 16500 --&gt;
										&lt;!-- ID Prod: 17111 --&gt;
										&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="&lt;% out &lt;&lt; componentManager.getApplicationProperties().getString("jira.baseurl") %&gt;/browse/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
										&lt;% if (issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
                                        &lt;% if (!issue.description.toString().contains("{html}")) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													$issue.description
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HS] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; !groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers') &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-internal-reporters')</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">HS-665</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="eventTypeId">1</arg>
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
            </function>
          </post-functions>
        </unconditional-result>
      </results>
    </action>
  </initial-actions>
  <common-actions>
    <action id="21" name="Resolve" view="fieldscreen">
      <meta name="opsbar-sequence">50</meta>
      <meta name="jira.description">This transition state the issue is moving to a field test to verify it's resolution</meta>
      <meta name="jira.fieldscreen.id">15200</meta>
      <restrict-to>
        <conditions type="OR">
          <condition type="class">
            <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.conditions.SimpleScriptedCondition</arg>
            <arg name="FIELD_CONDITION">import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()

currentUser.name == 'atlassian' || (groupManager.isUserInGroup(currentUser.name, 'service-desk-agents') &amp;&amp; issue.getProjectObject().key == 'HS')</arg>
            <arg name="FIELD_PREVIEW_ISSUE" />
            <arg name="class.name">com.onresolve.jira.groovy.GroovyCondition</arg>
          </condition>
          <condition type="class">
            <arg name="class.name">com.atlassian.jira.workflow.condition.UserInGroupCondition</arg>
            <arg name="group">service-desk-agents-faac</arg>
          </condition>
        </conditions>
      </restrict-to>
      <results>
        <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="6">
          <post-functions>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
              <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Send mail to Reporter (status changed)</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">support@hubparking.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
              <arg name="FIELD_TO_ADDRESSES" />
              <arg name="FIELD_CC_ADDRESSES" />
              <arg name="FIELD_CC_USER_FIELDS" />
              <arg name="FIELD_FUNCTION_ID">√´¬è[√µ¬ß=√ì¬¶√ûw¬é4√ô√≠:√ë√è8m√è6o^]k¬ø:omw</arg>
              <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">HS-396</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="eventTypeId">13</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
              <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
          </post-functions>
        </unconditional-result>
      </results>
    </action>
    <action id="41" name="TransferToReporter" view="fieldscreen">
      <meta name="opsbar-sequence">30</meta>
      <meta name="jira.description">Action used to respond to customer</meta>
      <meta name="jira.fieldscreen.id">15000</meta>
      <validators>
        <validator name="" type="class">
          <arg name="contextHandling" />
          <arg name="hidFieldsList">timespent@@</arg>
          <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
        </validator>
      </validators>
      <results>
        <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="3">
          <post-functions>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
              <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">q¬Ω√π√ü¬á¬∫q√Ü¬Ω√ß√ç√£√èz√£V√¥√µ¬ß¬∫√µ¬∂√Ω√´¬¶¬û√ó¬Ø[</arg>
              <arg name="FIELD_NOTES">Set PreStatus value</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor;
import com.atlassian.jira.issue.CustomFieldManager;
import com.atlassian.jira.issue.fields.CustomField;
import com.atlassian.jira.issue.IssueManager;
import com.atlassian.jira.issue.Issue;

CustomFieldManager customFieldManager = ComponentAccessor.getCustomFieldManager();

CustomField preStatus = customFieldManager.getCustomFieldObjectByName("PreStatus")
def originalIssue = ComponentAccessor.getIssueManager().getIssueObject(issue.id)

if (originalIssue.getStatusObject().name == "SupportWait"){
    issue.setCustomFieldValue(preStatus,"SupportWait".toString())
}else{
    if(originalIssue.getStatusObject().name == "OperationsWait"){
        issue.setCustomFieldValue(preStatus,"OperationsWait".toString())
    }else{
        if(originalIssue.getStatusObject().name == "QAWait"){
            issue.setCustomFieldValue(preStatus,"QAWait".toString())
        }else{
            issue.setCustomFieldValue(preStatus,"EngineeringWait".toString())
        }
    }
}</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
            <function type="class">
              <arg name="field.name">customfield_13616</arg>
              <arg name="full.module.key">com.googlecode.jira-suite-utilitiesupdateIssueCustomField-function</arg>
              <arg name="field.value">%%CURRENT_DATETIME%%</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.function.UpdateIssueCustomFieldPostFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
            </function>
            <function type="class">
              <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_NOTES">Send mail to Reporter (status changed)</arg>
              <arg name="FIELD_DISABLE_VALIDATION" />
              <arg name="FIELD_FROM">support@hubparking.com</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
              <arg name="FIELD_TO_ADDRESSES" />
              <arg name="FIELD_CC_ADDRESSES" />
              <arg name="FIELD_CC_USER_FIELDS">customfield_14404</arg>
              <arg name="FIELD_FUNCTION_ID">√ØF√ö√∑f¬üu√çtG¬ú√£n√ùsF¬õw¬éw√é¬ª√´√ç√π√µ√Æv</arg>
              <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
              <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
              <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
              <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
              <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_PREVIEW_ISSUE">HS-2039</arg>
              <arg name="FIELD_EMAIL_FORMAT">3</arg>
            </function>
            <function type="class">
              <arg name="eventTypeId">13</arg>
              <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
              <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
            </function>
            <function type="class">
              <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
              <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
              <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
              <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
              <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
              <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
              <arg name="FIELD_SCRIPT_FILE" />
            </function>
          </post-functions>
        </unconditional-result>
      </results>
    </action>
  </common-actions>
  <steps>
    <step id="1" name=":‚Äî¬ß">
      <meta name="jira.status.id">1</meta>
      <actions>
<common-action id="21" />
        <action id="11" name="TransferToSupport" view="fieldscreen">
          <meta name="jira.description">The opened issue should be assigned to a technician and checked</meta>
          <meta name="jira.fieldscreen.id">11702</meta>
          <restrict-to>
            <conditions>
              <condition type="class">
                <arg name="FIELD_FUNCTION_ID">kf–æ—Å¬≠¬ß–ª}–∑nw–π¬ß–õ–µ–ü_Ozk–∑u–≥F—ö{}</arg>
                <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.conditions.SimpleScriptedCondition</arg>
                <arg name="FIELD_CONDITION">import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()

groupManager.isUserInGroup(currentUser.name, 'service-desk-agents') || groupManager.isUserInGroup(currentUser.name, 'HS-internal-reporters')</arg>
                <arg name="FIELD_PREVIEW_ISSUE" />
                <arg name="class.name">com.onresolve.jira.groovy.GroovyCondition</arg>
              </condition>
            </conditions>
          </restrict-to>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">assignee@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (status changed)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">√õ¬æzo¬¶√ú√±¬Æ6m¬Æ√∑¬∑¬ü√≥¬ß√≥√üu√ü^√©√≠t√ï√ù¬π</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: ????? --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: ????? --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()

issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-396</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">10600</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="161" name="AssignToTechnician" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">11702</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="1">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="2" name="SupportWait">
      <meta name="jira.status.id">10026</meta>
      <actions>
<common-action id="41" />
<common-action id="21" />
        <action id="61" name="TransferToEngineering" view="fieldscreen">
          <meta name="opsbar-sequence">10</meta>
          <meta name="jira.description">this issue need an Engineering Review</meta>
          <meta name="jira.fieldscreen.id">15001</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">assignee@@timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="4">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">s‚îêZ—ã–ø4‚îò‚ïßt‚ïí‚ïõ=—á~‚î§—ã‚ñÄ{m–é‚Ññq–øv—á_Z—Ég\</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">3</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="141" name="N¬∂¬ß¬±√∑¬´N∆í¬©z¬∂¬≠≈†‚Ä∞√¨" view="fieldscreen">
          <meta name="opsbar-sequence">20</meta>
          <meta name="jira.description">Move the issue on Purchasing, Backoffice or in Production</meta>
          <meta name="jira.fieldscreen.id">15001</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">assignee@@timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="8">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">3</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="181" name="Send comment to Reporter" view="fieldscreen">
          <meta name="opsbar-sequence">40</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">u¬æ√∂√ô¬Ωvw¬é√´¬é¬∂√°¬≠√µq¬æ¬∫√°√æ¬ªwn=√ù√ós¬∑</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-2984</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="281" name="N¬∂¬ß¬±√∑¬´N‚Äû " view="fieldscreen">
          <meta name="opsbar-sequence">40</meta>
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15001</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">assignee@@timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="9">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">3</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="3" name="E√™h¬Æ√ó¬´Y¬®¬≠">
      <meta name="jira.status.id">10027</meta>
      <actions>
        <action id="51" name="Expiration">
          <meta name="jira.description">too much time is passed without any answer</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="7">
              <post-functions>
                <function type="class">
                  <arg name="field.name">resolution</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdate-issue-field-function</arg>
                  <arg name="field.value">10301</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueFieldFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (status changed)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">√£G¬ö√ï√Ü√Ω√õG√ü√∑¬áz√ü√ç¬û√ü√ûu√õ¬é¬üs√ç¬∂√≥¬Ü√õi√Ω^</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')
</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-396</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="91" name="ReporterBackToSupport">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id" />
          <restrict-to>
            <conditions type="OR">
              <condition type="class">
                <arg name="conditionList">3</arg>
                <arg name="comparisonType">1</arg>
                <arg name="class.name">com.googlecode.jsu.workflow.condition.ValueFieldCondition</arg>
                <arg name="fieldValue">SupportWait</arg>
                <arg name="fieldsList">customfield_17104</arg>
              </condition>
              <condition type="class">
                <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.conditions.SimpleScriptedCondition</arg>
                <arg name="FIELD_CONDITION">cfValues['PreStatus'] == '' || cfValues['PreStatus'] == null</arg>
                <arg name="FIELD_PREVIEW_ISSUE" />
                <arg name="class.name">com.onresolve.jira.groovy.GroovyCondition</arg>
              </condition>
            </conditions>
          </restrict-to>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">[false - viene gi√† inviata la mail di new comment] Send mail to Reporter (status changed)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">wV√∑√ØF√û√©√ó7√üg¬ù√£g¬ú}¬ø4¬û;u¬≠¬ü{W√õ¬æ¬ö</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">false
/*
mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')
*/</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-396</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">7</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="101" name="TimeRearm">
          <meta name="jira.description">Loop Transition fro sending warning emails</meta>
          <restrict-to>
            <conditions>
              <condition type="class">
                <arg name="FIELD_FUNCTION_ID">√õ√ó8√£√ñ√úO√õW7√´g√©√Æ√ó√û¬ük¬Ω√ùk¬á¬Ω√ü¬ñ√ö</arg>
                <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.conditions.SimpleScriptedCondition</arg>
                <arg name="FIELD_CONDITION">import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()

groupManager.isUserInGroup(currentUser.name, 'service-desk-agents')</arg>
                <arg name="FIELD_PREVIEW_ISSUE" />
                <arg name="class.name">com.onresolve.jira.groovy.GroovyCondition</arg>
              </condition>
            </conditions>
          </restrict-to>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="3">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="191" name="Send comment to Reporter" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="3">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-2984</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="201" name="E√™h¬Æ√ó¬´¬ß$N∆í¬©z¬∂¬≠≈†‚Ä∞√¨">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id" />
          <restrict-to>
            <conditions>
              <condition type="class">
                <arg name="conditionList">3</arg>
                <arg name="comparisonType">1</arg>
                <arg name="class.name">com.googlecode.jsu.workflow.condition.ValueFieldCondition</arg>
                <arg name="fieldValue">OperationsWait</arg>
                <arg name="fieldsList">customfield_17104</arg>
              </condition>
            </conditions>
          </restrict-to>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="8">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">[false - viene gi√† inviata la mail di new comment] Send mail to Reporter (status changed)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">‚ñà}\—Ä–π]‚Ññn–üs–¥—è–∑n[y–æ—è–Ñ–∂‚ñÄ9sW:–≤–åz</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">false

/*
mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')
*/</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-612</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="211" name="ReporterBackToEngineering">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id" />
          <restrict-to>
            <conditions>
              <condition type="class">
                <arg name="conditionList">3</arg>
                <arg name="comparisonType">1</arg>
                <arg name="class.name">com.googlecode.jsu.workflow.condition.ValueFieldCondition</arg>
                <arg name="fieldValue">EngineeringWait</arg>
                <arg name="fieldsList">customfield_17104</arg>
              </condition>
            </conditions>
          </restrict-to>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="4">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">[false - viene gi√† inviata la mail di new comment] Send mail to Reporter (status changed)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">√©√é¬∫√±√Ω¬ùi√Ü¬µ√üWZ√•√Ω[√Ø¬û√π√Ø¬∑6√ì¬Ω[√≥√û√´¬Æ¬º</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">false

/*
mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')
*/</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-2984</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="291" name="E√™h¬Æ√ó¬´¬ß$N‚Äû ">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id" />
          <restrict-to>
            <conditions>
              <condition type="class">
                <arg name="conditionList">3</arg>
                <arg name="comparisonType">1</arg>
                <arg name="class.name">com.googlecode.jsu.workflow.condition.ValueFieldCondition</arg>
                <arg name="fieldValue">QAWait</arg>
                <arg name="fieldsList">customfield_17104</arg>
              </condition>
            </conditions>
          </restrict-to>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="9">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="4" name="EngineeringWait">
      <meta name="jira.status.id">10028</meta>
      <actions>
<common-action id="41" />
        <action id="121" name="x&quot;¬ù√ß¬´¬äxi√â¬°+¬©¬¶¬ä√≠" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">12403</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">assignee@@timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">3</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="231" name="Send comment to Reporter" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="4">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-2984</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="5" name="Closed">
      <meta name="jira.status.id">6</meta>
      <actions>
        <action id="261" name="ReOpen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id" />
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="6">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="271" name="Send comment to Reporter" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="5">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√ß¬ç√∫i√üz√≠√ù¬ös√é¬¥u¬æ¬Ωk¬Ü√π√ì√ûZ√ü^6√ß¬ç^√ì¬ç√µ</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
def targetStatusId = 6

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="6" name="E√´(¬ñ√∑¬ù">
      <meta name="jira.status.id">5</meta>
      <actions>
        <action id="31" name="Close" view="fieldscreen">
          <meta name="jira.description">This action closes the ticket assuming that the issue is validated from the field</meta>
          <meta name="jira.fieldscreen.id">15002</meta>
          <restrict-to>
            <conditions>
              <condition type="class">
                <arg name="FIELD_FUNCTION_ID">√õ√ó8√£√ñ√úO√õW7√´g√©√Æ√ó√û¬ük¬Ω√ùk¬á¬Ω√ü¬ñ√ö</arg>
                <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.conditions.SimpleScriptedCondition</arg>
                <arg name="FIELD_CONDITION">import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()

groupManager.isUserInGroup(currentUser.name, 'service-desk-agents')</arg>
                <arg name="FIELD_PREVIEW_ISSUE" />
                <arg name="class.name">com.onresolve.jira.groovy.GroovyCondition</arg>
              </condition>
            </conditions>
          </restrict-to>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">customfield_13916@@timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="5">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">i√Ω√π√´¬æ_q√≠\q√ó¬∫}√ø:{√á¬µq√æ¬∂√ó√ç}√ñ√Ω√°√∂¬Ω</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)
/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero la lingua del reporter sul portale */
def targetStatusId = 6

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (status changed)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">–∑‚â†;o–ùxs–≠Zq‚àÜ—á—ü–Æ—ô}—ü—è–àz–µ–æ—ñwWw{My</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-396</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="171" name="ReOpen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id" />
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="field.name">resolution</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdate-issue-field-function</arg>
                  <arg name="field.value" />
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueFieldFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (status changed)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - Request Status Changed][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')
</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-2984</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="321" name="Send comment to Reporter" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="6">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
def targetStatusId = 6

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="7" name="Expired">
      <meta name="jira.status.id">10029</meta>
      <actions>
        <action id="111" name="ReOpen">
          <meta name="jira.description">This issue needs to go back to the technical assistance</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="field.name">resolution</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowupdate-issue-field-function</arg>
                  <arg name="field.value" />
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueFieldFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NONE</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_FUNCTION_ID">–≥–èvw–ß¬∂–≥–ã\–≠–Ω}w]—ú–π¬Æ¬ª–≠–∑—å–±—è6–ª–≠}–©—é–≠</arg>
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;head&gt;
	&lt;style type="text/css"&gt;
		td, a, h2 {color: #003050}
		.value, .label {color: #003050}
		.request-status {color: #003050}
		.header-request-link {color: #6ba539}
	&lt;/style&gt;
&lt;/head&gt;

&lt;body style="background-color: #f5f5f5; font-size: 16px; font-family: sans-serif"&gt;
        &lt;span class="preheader" style="display: none !important; font-size:1px; line-height: 1px; display: none; font-size: 1px; line-height: 1px"&gt;Status of the request $issue.summary with key $issue has been changed... &lt;/span&gt;&lt;center&gt;
            &lt;table id="email-wrap" valign="top" border="0" cellpadding="0" cellspacing="0" style="width: 100%; font-family: sans-serif; background-color: #f5f5f5; font-size: 16px; font-family: sans-serif"&gt;
                &lt;tbody&gt;
                    &lt;tr&gt;
                        &lt;td align="center" id="email-wrap-cell" style="padding: 20px 10px 10px"&gt;
                            &lt;table id="email-container" border="0" cellpadding="0" cellspacing="0" style="width: 100%; font-family: sans-serif; width: 600px; line-height: 1,500"&gt;
                                &lt;tbody&gt;
                                    &lt;tr&gt;
                                        &lt;td align="left"&gt;
                                            &lt;table border="0" cellpadding="0" cellspacing="0" style="width: 100%; font-family: sans-serif"&gt;
                                                &lt;tbody&gt;
                                                    &lt;tr&gt;
                                                        &lt;td class="email-header" style="padding: 10px 20px; border: solid #ddd; border-width: 1px 2px 1px 1px; border-bottom-color: #f5f5f5; background-color: #fff; font-weight: normal; line-height: 1,200"&gt;
                                                            &lt;table border="0" cellpadding="0" cellspacing="0" style="width: 100%; font-family: sans-serif; width: 100%"&gt;
                                                                &lt;tbody&gt;
																	&lt;tr&gt;
																		&lt;td class="viewport-details" style="width: 100%" align="right" colspan="2"&gt;
																			&lt;img src="/images/loghi/HUB Logo2.jpg"/&gt;
																		&lt;/td&gt;
																	&lt;/tr&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="viewport-details" style="width: 50%"&gt;
                                                                            &lt;a href="http://support.hubparking.com/servicedesk/customer/portal/2" style="font-size: 14px; font-weight: normal; text-decoration: none; "&gt;&lt;strong style="font-weight: bold"&gt;HUB Support Portal&lt;/strong&gt; - Support Request&lt;/a&gt;
                                                                        &lt;/td&gt;
                                                                        &lt;td class="request-key" style="width: 50%; text-align: right; font-size: 12px; line-height: 18px; text-decoration: none"&gt;
                                                                            &lt;!-- &lt;a href="http://support.hubparking.com/servicedesk/customer/portal/2/$issue" style="font-size: 14px; font-weight: normal; text-decoration: none; color: #707070"&gt;Reference: &lt;strong style="font-weight: bold"&gt;[$issue]&lt;/strong&gt;&lt;/a&gt; --&gt;
																			Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                &lt;/tbody&gt;
                                                            &lt;/table&gt;
                                                        &lt;/td&gt;
                                                    &lt;/tr&gt;
                                                    &lt;tr&gt;
                                                        &lt;td class="email-content-important email-heading" style="text-align: left; padding: 20px; border-style: solid; border-width: 0 2px 0 1px; border-color: #fff #ddd #ddd; background-color: #fff; padding-top: 10px; border-top-color: #f5f5f5"&gt;
                                                            &lt;h1 style="margin: 0; line-height: 1,200; font-size: 22px; font-weight: bold;"&gt;&lt;a href="http://support.hubparking.com/servicedesk/customer/portal/2/$issue" class="header-request-link" style="text-decoration: none"&gt;$issue.summary&lt;/a&gt; &lt;span class="request-status aui-lozenge aui-lozenge-current" style="background-color: #cccccd; border: 1px solid #cccccd; border-radius: 3px; color: #333; display: inline-block; font-size: 11px; font-weight: bold; line-height: 1; padding: 2px 5px 1px 5px; text-align: center; text-decoration: none; text-transform: uppercase; background-color: #4A6785; border-color: #4A6785; color: #ffffff; margin-left: 5px; font-weight: bold; font-size: 14px"&gt;$issue.status.name&lt;/span&gt;&lt;/h1&gt;
                                                        &lt;/td&gt;
                                                    &lt;/tr&gt;
													&lt;tr&gt;
                                                        &lt;td class="latest-activity-container email-content-important" style="text-align: left; padding: 20px; border-style: solid; border-width: 0 2px 0 1px; border-color: #fff #ddd #ddd; background-color: #fff; padding-top: 0; border-top-width: 0"&gt;
                                                            &lt;table border="0" cellpadding="0" cellspacing="0" style="width: 100%; font-family: sans-serif"&gt;
                                                                &lt;tbody&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="latest-activity activity-item status-update " style="padding: 20px 10px; border-top: solid 1px #ccc; display: block; margin: 0; padding: 10px; border: solid 1px; border-radius: 3px; border-color: #4A6785; background-color: #fffdf6"&gt;
                                                                            &lt;div class="content" style="float: left; line-height: 1,600; clear: both"&gt;
                                                                                Status changed to &lt;strong style="font-weight: bold"&gt;$issue.status.name&lt;/strong&gt;
                                                                            &lt;/div&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                &lt;/tbody&gt;
                                                            &lt;/table&gt;
                                                        &lt;/td&gt;
                                                    &lt;/tr&gt;
                                                    &lt;tr&gt;
                                                        &lt;td class="email-actions email-content-important" style="text-align: left; padding: 20px; border-style: solid; border-width: 0 2px 0 1px; border-color: #fff #ddd #ddd; background-color: #fff; padding: 20px; padding-top: 0; padding-bottom: 20px; border-top-width: 0; border-bottom-width: 2px"&gt;
                                                            You can &lt;a href="http://support.hubparking.com/servicedesk/customer/portal/2/$issue"&gt;view the full request&lt;/a&gt;
                                                        &lt;/td&gt;
                                                    &lt;/tr&gt;
													
													&lt;tr&gt;
                                                        &lt;td class="email-details" style="padding: 20px"&gt;
                                                            &lt;h2 style="margin: 0 0 10px; line-height: 1,200; font-size: 16px; font-weight: bold"&gt;Details&lt;/h2&gt;
                                                            &lt;table class="email-request-details" border="0" cellpadding="0" cellspacing="0" style="width: 100%; font-family: sans-serif"&gt;
                                                                &lt;tbody&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="label" style="padding: 5px 0;  width: 120px; padding-right: 10px; font-size: 14px"&gt;
                                                                            Brand
                                                                        &lt;/td&gt;
                                                                        &lt;td class="value" style="padding: 5px 0"&gt;
                                                                            &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="label" style="padding: 5px 0;  width: 120px; padding-right: 10px; font-size: 14px"&gt;
                                                                            Environment
                                                                        &lt;/td&gt;
                                                                        &lt;td class="value" style="padding: 5px 0"&gt;
                                                                            &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="label" style="padding: 5px 0;  width: 120px; padding-right: 10px; font-size: 14px"&gt;
                                                                            Product Family
                                                                        &lt;/td&gt;
                                                                        &lt;td class="value" style="padding: 5px 0"&gt;
                                                                            &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="label" style="padding: 5px 0;  width: 120px; padding-right: 10px; font-size: 14px"&gt;
                                                                            Product
                                                                        &lt;/td&gt;
                                                                        &lt;td class="value" style="padding: 5px 0"&gt;
                                                                            &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="label" style="padding: 5px 0;  width: 120px; padding-right: 10px; font-size: 14px"&gt;
                                                                            Affected Version / Peripheral Serial Number
                                                                        &lt;/td&gt;
                                                                        &lt;td class="value" style="padding: 5px 0"&gt;
                                                                            &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12904"))%&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                    &lt;tr&gt;
                                                                        &lt;td class="label" style="padding: 5px 0;  width: 120px; padding-right: 10px; font-size: 14px"&gt;
                                                                            Description
                                                                        &lt;/td&gt;
                                                                        &lt;td class="value" style="padding: 5px 0"&gt;
                                                                            &lt;p&gt;$issue.description&lt;/p&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                    &lt;tr class="last"&gt;
                                                                        &lt;td class="label" style="padding: 5px 0;  width: 120px; padding-right: 10px; font-size: 14px"&gt;
                                                                            What Is your installation number?
                                                                        &lt;/td&gt;
                                                                        &lt;td class="value" style="padding: 5px 0"&gt;
                                                                            &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
                                                                        &lt;/td&gt;
                                                                    &lt;/tr&gt;
                                                                &lt;/tbody&gt;
                                                            &lt;/table&gt;
                                                        &lt;/td&gt;
                                                    &lt;/tr&gt;
                                                &lt;/tbody&gt;
                                            &lt;/table&gt;
                                        &lt;/td&gt;
                                    &lt;/tr&gt;
                                &lt;/tbody&gt;
                            &lt;/table&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;td id="foot-note" style="padding-bottom: 20px;  font-size: 12px; line-height: 1,200"&gt;
                            &lt;p style="width: 600px; text-align: center; margin: 0 auto"&gt;This message is automatically generated by HUB Support Portal.&lt;br /&gt;&lt;/p&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/center&gt;
    &lt;/body&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">false
/*
import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')
*/</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-396</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="241" name="Send comment to Reporter" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="7">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-2984</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="8" name="OperationsWait">
      <meta name="jira.status.id">10126</meta>
      <actions>
<common-action id="41" />
        <action id="151" name="OperationsBackToSupport" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">12403</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">assignee@@timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">3</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="251" name="Send comment to Reporter" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="8">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">–µ¬ß–Æ–∑–Æm¬ß¬µu–≠—çu–æ:u–Ö:w‚Ä°^—á¬ß—á–ß‚Äì—úk—ï–¨</arg>
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"

try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE">HS-2984</arg>
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_FUNCTION_ID">√©√∑;√≥¬ù_m√æ√Ωu√≠√∑√©√ß_O8oM|√≠¬∑¬∂√õF√¥√´F¬ª</arg>
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
    <step id="9" name="QAWait">
      <meta name="jira.status.id">12427</meta>
      <actions>
<common-action id="41" />
        <action id="301" name="Send comment to Reporter" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">15000</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="9">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Send mail to Reporter (new comment added)</arg>
                  <arg name="FIELD_DISABLE_VALIDATION" />
                  <arg name="FIELD_FROM">support@hubparking.com</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS">FIELD_INCLUDE_ATTACHMENTS_NEW</arg>
                  <arg name="FIELD_TO_ADDRESSES" />
                  <arg name="FIELD_CC_ADDRESSES" />
                  <arg name="FIELD_CC_USER_FIELDS" />
                  <arg name="FIELD_TO_USER_FIELDS">¬≠√™h¬Æ√ó¬´</arg>
                  <arg name="FIELD_INCLUDE_ATTACHMENTS_CALLBACK" />
                  <arg name="FIELD_EMAIL_TEMPLATE">&lt;html&gt;
&lt;head&gt;
	&lt;style&gt;
    	table.custom-outgoing-mail{
        	font-family:"calibri";
        	width:100%;
        	border-spacing: 8px 2px;
        }
        a.hub-summary{
        	color:#6BA539;
        	text-decoration:none;
        }
        td.td-spaced{
        	padding:15.0pt 7.5pt 7.5pt 7.5pt;
        }
        td.td-summary{
        	font-family:"Segoe UI Symbol";
            font-size:18pt;
            font-weight:bold;
        	border-top:whitesmoke 1.0pt;
        	border-left:#DDDDDD 1.0pt;
        	border-bottom:#DDDDDD 1.0pt;
        	border-right:#DDDDDD 1.5pt;
        	border-style:solid;
        	background:white;
			padding-left:10px;
        }
		td.td-reference{
			border-top:white 1.0pt;
			border-left:#DDDDDD 1.0pt;
			border-bottom:#DDDDDD 1.5pt;
			border-right:#DDDDDD 1.5pt;
			border-style:solid;
			background:white;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
		}
		a.td-reference{
			font-family:"calibri";
			color:#003050;
			font-size:11pt;
			text-decoration:underline;
		}
		p.title-comment{
			font-family:"Segoe UI Symbol";
            font-size:12pt;
            font-weight:bold;
			text-decoration:underline;
		}
		p.author-comment{
			font-family:"Segoe UI Symbol";
            font-size:11pt;
            font-weight:bold;
		}
		td.comment-box{
			background:#F2F2F2;
			padding:10px 10px 10px 10px;
			font-family:"calibri";
			font-size:11pt;
		}
		td.details-field-name{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.details-box-title{
			font-family:"Segoe UI Symbol";
			font-size:11pt;
			font-weight:bold;
			padding-top: 15px;
			padding-bottom: 10px;
		}
		td.details-field-value{
			font-size:10pt;
			font-family:"Segoe UI Symbol";
			vertical-align:middle;
			padding-top: 2px;
			padding-bottom: 2px;
		}
		p.hub-header-firma{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			padding-bottom: 0px;
		}
		span.hub-content-firma{
			font-family:"Segoe UI Symbol";
			font-size:8pt;
			padding-top: 0px;
			padding-left: 10px;
		}
		span.hub-header-firma-blue{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#003050;
			padding-left: 10px;
		}
		span.hub-header-firma-green{
			font-family:"Segoe UI Symbol";
			font-size:10pt;
			font-weight:bold;
			color:#6BA539;
		}
		a.title-mail-reference{
			font-family:"calibri";
			padding-top: 5px;
			padding-bottom: 5px;
			padding-left: 10px;
			display: inline-block;
			font-size:11pt;
			color:#003050;
		}
		p.title-mail-reference{
			padding-top: 5px;
			padding-bottom: 5px;
			padding-right: 10px;
			text-align:right;
			line-height:13pt;
			font-family:"calibri";
			font-size:11pt;
			display: inline-block;
			color:#003050;
		}
		p.type-above{
			font-family:"calibri";
			font-size:8pt;
			font-weight:bold;
			color:#505050;
		}
		span.status-name-yellow{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #ffd351; 
			border: 1px solid #ffd351; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-green{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #14892C; 
			border: 1px solid #14892C; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
		span.status-name-blue{
			border-radius: 3px; 
			font-size: 11px; 
			text-align: center; 
			text-transform: uppercase; 
			background-color: #4A6785; 
			border: 1px solid #4A6785; 
			color: #ffffff; 
			margin-left: 5px; 
			font-weight: bold; 
			font-size: 14px;
		}
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div align="center"&gt;
	&lt;p class="type-above"&gt;##Please type your reply above this line##&lt;/p&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;table class="custom-outgoing-mail" border=0 cellspacing=0 cellpadding=0 width="100%"&gt;
	&lt;tr&gt;
		&lt;td class="td-spaced"&gt;
			&lt;div align="center"&gt;
				&lt;table border=0 cellspacing=0 cellpadding=0 width=600 style='width:450pt'&gt;
					&lt;tr&gt;
						&lt;td style='padding:0cm 0cm 0cm 0cm'&gt;
							&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
								&lt;tr&gt;
									&lt;td&gt;
										&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
											&lt;tr&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm'&gt;
													&lt;p&gt;
															&lt;a class="title-mail-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24"&gt;
                                                              &lt;b&gt;HUB Support Portal&lt;/b&gt;	- Support Request
															&lt;/a&gt;
													&lt;/p&gt;
												&lt;/td&gt;
												&lt;td width="50%" style='width:50.0%;padding:0cm 0cm 0cm 0cm;text-align:right;'&gt;
													&lt;p class="title-mail-reference" &gt;
															Reference: &lt;strong style="font-weight: bold"&gt;$issue&lt;/strong&gt;
													&lt;/p&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;/table&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-summary"&gt;
												&lt;a class="hub-summary" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
													$issue.summary
												&lt;/a&gt;
												&lt;!-- Custom field: Next Status Description --&gt;
												&lt;!-- ID Svil: 15602 --&gt;
												&lt;!-- ID Prod: 15801 --&gt;
												&lt;!-- Custom field: Next Status Color --&gt;
												&lt;!-- ID Svil: 16500 --&gt;
												&lt;!-- ID Prod: 17111 --&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("green")) { %&gt;
													&lt;span class="status-name-green"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("yellow")) { %&gt;
													&lt;span class="status-name-yellow"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
												&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")) != null &amp;&amp; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17111")).toString().equals("blue-gray")) { %&gt;
													&lt;span class="status-name-blue"&gt; &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_15801"))%&gt; &lt;/span&gt;
												&lt;% } %&gt;
									&lt;/td&gt;
								&lt;/tr&gt;
								&lt;tr&gt;
									&lt;td class="td-reference"&gt;
										You can 										
											&lt;a class="td-reference" href="https://support.hubparking.com/servicedesk-ui/customer/portal/24/myrequests/$issue"&gt;
												view the full request
											&lt;/a&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;

						&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%'&gt;
							&lt;tr&gt;
								&lt;td class="comment-box"&gt;									
									&lt;% if (componentManager.commentManager.getComments(issue).size() != 0 &amp;&amp; lastComment != null &amp;&amp; lastComment != "") { %&gt;
										&lt;p class="title-comment"&gt;
											&lt;b&gt;&lt;u&gt;New comment added to the request&lt;/u&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p class="author-comment"&gt;
											&lt;b&gt;&lt;% out &lt;&lt; componentManager.userUtil.getUserObject(componentManager.commentManager.getComments(issue)?.last()?.author.toString()).getDisplayName() %&gt;&lt;/b&gt;
											&lt;b&gt;&lt;span style='font-size:10.0pt;font-family:"Segoe UI Symbol";color:#1F497D'&gt;&lt;/span&gt;&lt;/b&gt;
										&lt;/p&gt;
										&lt;p style='margin-top:6.0pt'&gt;
											&lt;span style='font-family:"Segoe UI Symbol";color:#003050'&gt;
												&lt;% out &lt;&lt; lastComment %&gt;
											&lt;/span&gt;
										&lt;/p&gt;
									&lt;% } %&gt;
									&lt;p class="details-box-title"&gt;
										&lt;b&gt;&lt;span style='font-family:"Segoe UI Symbol"'&gt;Details&lt;/span&gt;&lt;/b&gt;
										
									&lt;/p&gt;
									&lt;table border=0 cellspacing=0 cellpadding=0 width="100%" style='width:100%;'&gt;
									
										&lt;% if (issue.description != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Description&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% if(issue.description.toString().contains("{html}")) { %&gt;
														&lt;% out &lt;&lt; issue.description.toString().substring(issue.description.toString().indexOf("{html}")+6, issue.description.toString().lastIndexOf("{html}")) %&gt;
													&lt;% } %&gt;
													&lt;% if(!issue.description.toString().contains("{html}")) { %&gt;
														$issue.description
													&lt;% } %&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Brand --&gt;
										&lt;!-- ID Svil: 12900 --&gt;
										&lt;!-- ID Prod: 12900 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
													  &lt;b&gt;Brand &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12900"))%&gt; 
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Environment --&gt;
										&lt;!-- ID Svil: 12901 --&gt;
										&lt;!-- ID Prod: 12901 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Environment &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												  &lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12901"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product Family --&gt;
										&lt;!-- ID Svil: 12902 --&gt;
										&lt;!-- ID Prod: 12902 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product Family &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12902"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: HUB Product --&gt;
										&lt;!-- ID Svil: 12903 --&gt;
										&lt;!-- ID Prod: 12903 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Product &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
													&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_12903"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
										&lt;!-- Custom field: Installation Number --&gt;
										&lt;!-- ID Svil: 11002 --&gt;
										&lt;!-- ID Prod: 11002 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_11002"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: New Installation Number --&gt;
										&lt;!-- ID Svil: 16201 --&gt;
										&lt;!-- ID Prod: 17108 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;Missing Installation Number &lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17108"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										&lt;!-- Custom field: JMS License Number --&gt;
										&lt;!-- ID Svil: 16300 --&gt;
										&lt;!-- ID Prod: 17106 --&gt;
										&lt;% if (issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106")) != null) { %&gt;
											&lt;tr&gt;
												&lt;td width="30%" class="details-field-name"&gt;
												  &lt;b&gt;JMS License Number&lt;/b&gt;
												&lt;/td&gt;
												&lt;td class="details-field-value"&gt;
												&lt;% out &lt;&lt; issue.getCustomFieldValue(componentManager.getCustomFieldManager().getCustomFieldObject("customfield_17106"))%&gt;
												&lt;/td&gt;
											&lt;/tr&gt;
										&lt;% } %&gt;
										
									&lt;/table&gt;
									
								&lt;/td&gt;
							&lt;/tr&gt;
							&lt;tr&gt;
								&lt;td&gt;
								&lt;p class="hub-header-firma"&gt;
									&lt;span class="hub-header-firma-blue"&gt;HUB Parking &lt;/span&gt;&lt;span class="hub-header-firma-green"&gt;Technology&lt;/span&gt;&lt;br/&gt;
									&lt;span class="hub-content-firma"&gt;a Business Unit of the FAAC Group&lt;/span&gt;
								&lt;/p&gt;
								&lt;/td&gt;
							&lt;/tr&gt;
						&lt;/table&gt;
						
						&lt;/td&gt;
					&lt;/tr&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td style='padding:0cm 0cm 15.0pt 0cm;'&gt;
			&lt;p align=center style='margin:0cm;margin-bottom:.0001pt;text-align:center'&gt;
				&lt;span style='font-size:9.0pt;font-family:"Segoe UI Symbol";color:#003050'&gt;This message is automatically generated by HUB Support Portal.&lt;/span&gt;
			&lt;/p&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</arg>
                  <arg name="FIELD_EMAIL_SUBJECT_TEMPLATE">[HUB Support Portal - New Comment][$issue.key] $issue.summary</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.SendCustomEmail</arg>
                  <arg name="FIELD_CONDITION">mail.setFrom("support@hubparking.com")

import com.atlassian.jira.component.ComponentAccessor

def groupManager = ComponentAccessor.getGroupManager()
issue.projectObject.name == 'HUB Support' &amp;&amp; groupManager.isUserInGroup(issue.reporter?.name, 'HS-customers')</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_PREVIEW_ISSUE" />
                  <arg name="FIELD_EMAIL_FORMAT">3</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">13</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Update public comments and attachments tables on DB</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.component.ComponentAccessor
import org.apache.log4j.Category
import com.atlassian.jira.issue.comments.Comment
import com.atlassian.jira.issue.comments.MutableComment
import org.ofbiz.core.entity.GenericValue
import com.atlassian.jira.issue.history.ChangeItemBean

import groovy.sql.Sql
import java.sql.Connection
import org.ofbiz.core.entity.ConnectionFactory
import org.ofbiz.core.entity.DelegatorInterface

Category log = Category.getInstance("com.onresolve.jira.groovy.CreateDependentIssue")
log.setLevel(org.apache.log4j.Level.DEBUG)

def delegator = (DelegatorInterface) ComponentAccessor.getComponent(DelegatorInterface)
String helperName = delegator.getGroupHelperName("default");
def sqlStmt
Connection conn
Sql sql

List&lt;ChangeItemBean&gt; changeItems = transientVars["changeItems"] as List
Comment comment = (Comment)transientVars.get("commentValue");

changeItems.each {item -&gt;
    if (item.getField().toString().equals("Attachment")){
        
        if (comment != null){
			sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY, REQUEST_COMMENT_ID) VALUES (" + item.getTo() + ", '" + issue.key + "', " + comment.id + ")"
        }else{
            sqlStmt = "INSERT INTO FC_SD_REQUESTATTACHMENTS (JIRA_ATTACHMENT_ID, JIRA_ISSUE_KEY) VALUES (" + item.getTo() + ", '" + issue.key + "')"
        }
        
        conn = ConnectionFactory.getConnection(helperName);
		sql = new Sql(conn)

        try {
            StringBuffer sb = new StringBuffer()
            sql.execute(sqlStmt)
        }
        finally {
            sql.close()
		}
	}
}


if (comment != null){

    MutableComment comment_to_be_updated = ComponentAccessor.getCommentManager().getMutableComment(comment.getId());
    comment_to_be_updated.setRoleLevelId("10300".toLong())
    ComponentAccessor.getCommentManager().update(comment_to_be_updated, false);

    sqlStmt = "INSERT INTO FC_SD_REQUESTCOMMENTS (JIRA_COMMENT_ID, JIRA_ISSUE_KEY) VALUES (" + comment.id + ", '" + issue.key + "')"
    
    conn = ConnectionFactory.getConnection(helperName);
    sql = new Sql(conn)
    
    try {
        StringBuffer sb = new StringBuffer()
        sql.execute(sqlStmt)
    }
    finally {
        sql.close()
    }    
}
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
        <action id="311" name="QABackToSupport" view="fieldscreen">
          <meta name="jira.description" />
          <meta name="jira.fieldscreen.id">12403</meta>
          <validators>
            <validator name="" type="class">
              <arg name="contextHandling" />
              <arg name="hidFieldsList">assignee@@timespent@@</arg>
              <arg name="class.name">com.googlecode.jsu.workflow.validator.FieldsRequiredValidator</arg>
            </validator>
          </validators>
          <results>
            <unconditional-result old-status="≈æ√©e" status="≈æ√©e" step="2">
              <post-functions>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.UpdateIssueStatusFunction</arg>
                </function>
                <function type="class">
                  <arg name="FIELD_NOTES">Set Next Status Description - customer portal description</arg>
                  <arg name="full.module.key">com.onresolve.jira.groovy.groovyrunnerrungroovy-function</arg>
                  <arg name="FIELD_INLINE_SCRIPT">import com.atlassian.jira.issue.util.DefaultIssueChangeHolder
import com.atlassian.jira.issue.util.IssueChangeHolder
import com.atlassian.jira.issue.ModifiedValue
import com.atlassian.jira.component.ComponentAccessor
import groovy.sql.Sql
import java.sql.Driver
import org.apache.log4j.Logger
import org.apache.log4j.Level
import com.atlassian.jira.issue.history.ChangeItemBean

import com.opensymphony.workflow.spi.Step

 
def log = Logger.getLogger("com.acme.CreateSubtask")
log.setLevel(Level.DEBUG)

def tgtField = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("15801".toLong())
def tgtFieldValue = issue.getCustomFieldValue(tgtField)
def tgtFieldColor = ComponentAccessor.getCustomFieldManager().getCustomFieldObject("17111".toLong())
def tgtFieldColorValue = issue.getCustomFieldValue(tgtField)

def newStatusDesc = ""
def newStatusColor = ""
def userLanguage = ""

def driver = Class.forName('com.mysql.jdbc.Driver').newInstance() as Driver 

def props = new Properties()
props.setProperty("user", "JIRA_READER") 
props.setProperty("password", "R4dvV781!Zv")

def conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 

def sql = new Sql(conn)

/* Recupero la lingua del reporter sul portale */
def queryLanguage = "SELECT VALUE AS LANGUAGE_ID FROM JIRA_ServiceDesk.USERUSERPROFILE " +
					"JOIN USERPROFILEFIELD ON USERPROFILEFIELD.ID = USERUSERPROFILE.USERPROFILEFIELD_ID " +
					"JOIN USER ON USER.ID = USERUSERPROFILE.USER_ID " +
					"WHERE FIELD_NAME = 'language' AND JIRA_USER_KEY = '" + issue.reporter.name + "'"
try {
    sql.eachRow(queryLanguage) {
        userLanguage = it.LANGUAGE_ID
    }
} finally {
    sql.close()
    conn.close()
}

/* Recupero l'id dello stato target */
List&lt;ChangeItemBean&gt; cibs = (List&lt;ChangeItemBean&gt;) transientVars["changeItems"];

String targetStatusName = null;
def targetStatusId = null;
         
// find the destiny transitionname
for (ChangeItemBean cib:cibs) {
    if (cib.getField().equals("status") &amp;&amp; cib.getFieldType().equals("jira")) {
        targetStatusName = cib.getToString();
        targetStatusId = cib.getTo();
    }
}

if (targetStatusName == null) {
    log.error("Transition without know target status");
    return null;
}

def status = ComponentAccessor.getConstantsManager().getStatusObject(targetStatusId as String)
newStatusColor = status.getStatusCategory().getColorName()

def query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = '" + userLanguage + "' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
sql = new Sql(conn)

try {
    sql.eachRow(query) {
        newStatusDesc = it.LABEL
    }
} finally {
    sql.close()
    conn.close()
}

if(newStatusDesc == "" || newStatusDesc == null){
   query = "SELECT tl.LABEL " +
			"FROM TRANSLATEDLABEL as tl " + 
			"JOIN STATUSMAPPING as sm ON tl.TRANSLATION_ID = sm.LABEL_ID " +
			"JOIN PORTALREQUESTS as pr ON sm.REQUEST_TYPE_ID = pr.VIEWPORTREQUESTTYPE_ID " +
			"WHERE tl.TRANSLATION_ID = sm.LABEL_ID AND LANGUAGE_ID = 'en' " +
			"AND pr.JIRA_ISSUE_KEY = '" + issue.key + "' AND sm.JIRA_STATUS_ID = " + targetStatusId

    conn = driver.connect("jdbc:mysql://172.30.0.157:3306/JIRA_ServiceDesk", props) 
    sql = new Sql(conn)

    try {
        sql.eachRow(query) {
            newStatusDesc = it.LABEL
        }
    } finally {
        sql.close()
        conn.close()
    }   
}

def changeHolder = new DefaultIssueChangeHolder();
tgtField.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtField), newStatusDesc), changeHolder);
issue.setCustomFieldValue(tgtField,newStatusDesc)

tgtFieldColor.updateValue(null, issue, new ModifiedValue(issue.getCustomFieldValue(tgtFieldColor), newStatusColor), changeHolder);
issue.setCustomFieldValue(tgtFieldColor,newStatusColor)
</arg>
                  <arg name="canned-script">com.onresolve.scriptrunner.canned.jira.workflow.postfunctions.CustomScriptFunction</arg>
                  <arg name="class.name">com.onresolve.jira.groovy.GroovyFunctionPlugin</arg>
                  <arg name="FIELD_SCRIPT_FILE" />
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.misc.CreateCommentFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.GenerateChangeHistoryFunction</arg>
                </function>
                <function type="class">
                  <arg name="class.name">com.atlassian.jira.workflow.function.issue.IssueReindexFunction</arg>
                </function>
                <function type="class">
                  <arg name="eventTypeId">3</arg>
                  <arg name="full.module.key">com.atlassian.jira.plugin.system.workflowfireevent-function</arg>
                  <arg name="class.name">com.atlassian.jira.workflow.function.event.FireIssueEventFunction</arg>
                </function>
              </post-functions>
            </unconditional-result>
          </results>
        </action>
      </actions>
    </step>
  </steps>
</workflow>